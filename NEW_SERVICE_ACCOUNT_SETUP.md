# New Firebase Service Account Setup Guide

**Quick Start:** Generate and configure a new Firebase service account key after security incident

**Time Required:** 15-20 minutes

---

## Prerequisites

- [ ] Access to Firebase Console (with Owner role)
- [ ] Access to GitHub repository settings
- [ ] Firebase CLI installed (`npm install -g firebase-tools`)
- [ ] PowerShell (Windows) or Bash (Mac/Linux)

---

## Step 1: Generate New Service Account Key (5 minutes)

### In Firebase Console

1. **Navigate to Firebase Console:**
   - Go to: https://console.firebase.google.com/
   - Sign in with your Google account

2. **Select Project:**
   - Click on **"adopt-a-young-parent"** project

3. **Access Service Accounts:**
   - Click the **gear icon** (Settings) in the left sidebar
   - Select **Project Settings**
   - Click on the **Service Accounts** tab

4. **Generate New Private Key:**
   - Scroll down to "Firebase Admin SDK"
   - Click **"Generate New Private Key"** button
   - A warning dialog will appear
   - Click **"Generate Key"** to confirm

5. **Save the Downloaded File:**
   - Your browser will download a JSON file named something like:
     `adopt-a-young-parent-firebase-adminsdk-fbsvc-xxxxxx.json`
   - Note the location (usually your Downloads folder)

### Document the New Key

```powershell
# Create credentials directory (if it doesn't exist)
$credDir = "C:\firebase-credentials"
if (-not (Test-Path $credDir)) {
    New-Item -ItemType Directory -Path $credDir -Force
}

# Move downloaded file from Downloads to secure location
$downloadedFile = Get-ChildItem "$env:USERPROFILE\Downloads\adopt-a-young-parent-*.json" |
                  Sort-Object LastWriteTime -Descending |
                  Select-Object -First 1

if ($downloadedFile) {
    $targetFile = "$credDir\firebase-service-account.json"
    Move-Item $downloadedFile.FullName $targetFile -Force
    Write-Host "✅ Service account key saved to: $targetFile" -ForegroundColor Green

    # Read and display key information
    $key = Get-Content $targetFile | ConvertFrom-Json
    Write-Host ""
    Write-Host "📋 Key Details:" -ForegroundColor Cyan
    Write-Host "  Project ID: $($key.project_id)" -ForegroundColor White
    Write-Host "  Client Email: $($key.client_email)" -ForegroundColor White
    Write-Host "  Key ID: $($key.private_key_id)" -ForegroundColor Yellow
    Write-Host ""
    Write-Host "⚠️  Save this Key ID for your records!" -ForegroundColor Yellow

    # Log the generation
    Add-Content -Path "$credDir\key-history.txt" -Value @"
$(Get-Date -Format "yyyy-MM-dd HH:mm:ss") - New key generated
  Key ID: $($key.private_key_id)
  Generated by: $env:USERNAME
  Purpose: Replace compromised key 813342c77db74eea85ab569b136749aa6702b8eb
  Next rotation: $(Get-Date).AddDays(90).ToString("yyyy-MM-dd")

"@
} else {
    Write-Host "❌ No service account file found in Downloads" -ForegroundColor Red
    Write-Host "Please locate the downloaded JSON file manually" -ForegroundColor Yellow
}
```

---

## Step 2: Update GitHub Actions Secret (3 minutes)

### In GitHub Repository Settings

1. **Navigate to Repository Secrets:**
   - Go to: https://github.com/Instawerx/AYPNFP
   - Click **Settings** tab (top right)
   - In left sidebar, click **Secrets and variables** → **Actions**

2. **Update FIREBASE_SERVICE_ACCOUNT Secret:**
   - Find `FIREBASE_SERVICE_ACCOUNT` in the list
   - Click the **pencil icon** (Update) next to it
   - Or click **Update** button

3. **Paste New Credential:**
   ```powershell
   # Copy entire file contents to clipboard
   Get-Content C:\firebase-credentials\firebase-service-account.json | Set-Clipboard
   Write-Host "✅ File contents copied to clipboard" -ForegroundColor Green
   Write-Host "Paste into GitHub secret value field" -ForegroundColor Yellow
   ```
   - Paste the copied JSON into the secret value field
   - Click **Update secret**

4. **Verify:**
   - You should see: "Secret updated" confirmation
   - The updated date should show current date/time

---

## Step 3: Update Firebase Secret Manager (5 minutes)

### Set Environment Variable

```powershell
# Set the path to your new credential file
$env:FIREBASE_SERVICE_ACCOUNT_PATH = "C:\firebase-credentials\firebase-service-account.json"

# Verify it's set
Write-Host "Environment variable set to: $env:FIREBASE_SERVICE_ACCOUNT_PATH" -ForegroundColor Green
```

### Login to Firebase CLI

```bash
# Login to Firebase (if not already logged in)
firebase login

# Verify you're logged in
firebase projects:list
# Should show "adopt-a-young-parent" in the list
```

### Update the Secret

```powershell
# Run the setup script (uses environment variable)
.\setup-firebase-secret.ps1
```

**OR manually update the secret:**

```bash
# Extract private key and create secret
firebase apphosting:secrets:set firebase-admin-private-key \
  --data-file="C:\firebase-credentials\firebase-service-account.json" \
  --project adopt-a-young-parent

# Verify secret was created
firebase apphosting:secrets:describe firebase-admin-private-key \
  --project adopt-a-young-parent
```

You should see output like:
```
Secret: firebase-admin-private-key
Created: [timestamp]
Updated: [current time]
Versions: 1 (or higher if updating)
```

---

## Step 4: Delete Old Compromised Key (2 minutes)

### In Firebase Console

1. **Return to Service Accounts tab:**
   - Firebase Console → Project Settings → Service Accounts

2. **Find Existing Keys:**
   - Scroll down to "Existing service account keys"
   - Look for keys with email: `firebase-adminsdk-fbsvc@...`

3. **Identify Compromised Key:**
   - Find the key with Key ID starting with: `813342c7...`
   - This is the compromised key

4. **Delete the Key:**
   - Click the **three dots** menu (⋮) next to the compromised key
   - Click **Delete**
   - Confirm the deletion
   - ✅ The old key is now revoked and cannot be used

**Note:** Google may have already disabled this key. If you don't see it or it shows as "disabled", that's expected.

---

## Step 5: Verify Setup (3 minutes)

### Test Local Setup

```powershell
# Verify environment variable is set
if ($env:FIREBASE_SERVICE_ACCOUNT_PATH) {
    Write-Host "✅ Environment variable set" -ForegroundColor Green
} else {
    Write-Host "❌ Environment variable NOT set" -ForegroundColor Red
}

# Verify file exists and is readable
if (Test-Path $env:FIREBASE_SERVICE_ACCOUNT_PATH) {
    $key = Get-Content $env:FIREBASE_SERVICE_ACCOUNT_PATH | ConvertFrom-Json
    Write-Host "✅ Credential file is valid" -ForegroundColor Green
    Write-Host "  Project: $($key.project_id)" -ForegroundColor White
    Write-Host "  Email: $($key.client_email)" -ForegroundColor White
} else {
    Write-Host "❌ Credential file not found" -ForegroundColor Red
}
```

### Test GitHub Actions

Trigger a deployment to test the new secret:

```bash
# Make a small change
echo "# Test" >> README.md

# Commit and push
git add README.md
git commit -m "Test new service account credentials"
git push origin main

# Watch the deployment
# Go to: https://github.com/Instawerx/AYPNFP/actions
# The workflow should complete successfully
```

### Test Firebase Secret Manager

```bash
# Verify secret is accessible
firebase apphosting:secrets:access firebase-admin-private-key \
  --project adopt-a-young-parent

# Should output the private key (first few lines)
# If you see the key, it's working!
```

---

## Step 6: Update Local Development Environment (2 minutes)

### Add to PowerShell Profile (Permanent)

```powershell
# Edit PowerShell profile
notepad $PROFILE

# Add this line at the end:
$env:FIREBASE_SERVICE_ACCOUNT_PATH = "C:\firebase-credentials\firebase-service-account.json"

# Save and close

# Reload profile
. $PROFILE

# Verify
Write-Host "Environment variable: $env:FIREBASE_SERVICE_ACCOUNT_PATH"
```

### Update .env.local (if using)

```bash
# If you have a .env.local file, update these lines:

# OLD (remove or comment out):
# FIREBASE_PRIVATE_KEY="old-key-here"

# NEW (extract from service account file):
# You can extract the private key manually or use the script:
```

```powershell
# Extract private key for .env.local
$key = Get-Content C:\firebase-credentials\firebase-service-account.json | ConvertFrom-Json
$privateKey = $key.private_key

# Display in format for .env.local
Write-Host "FIREBASE_CLIENT_EMAIL=$($key.client_email)"
Write-Host "FIREBASE_PRIVATE_KEY=`"$privateKey`""
```

---

## Step 7: Test the Application (Optional, 5 minutes)

### Run Development Server

```bash
# Start the dev server
npm run dev
```

### Test Firebase Admin Functions

1. **Navigate to:** http://localhost:3000
2. **Sign in** with your test account
3. **Try an admin operation:**
   - Go to `/portal/admin/users`
   - Try creating a test user
   - Verify it works without errors

### Check Console for Errors

- Open browser DevTools (F12)
- Look for any Firebase authentication errors
- Should see no errors related to service account

---

## Troubleshooting

### "Permission Denied" Error

**Problem:** Can't access Firebase Admin SDK functions

**Solution:**
1. Verify the service account has the right permissions:
   ```bash
   gcloud projects get-iam-policy adopt-a-young-parent \
     --flatten="bindings[].members" \
     --filter="bindings.members:firebase-adminsdk-fbsvc@*"
   ```

2. Grant Firebase Admin role if missing:
   ```bash
   gcloud projects add-iam-policy-binding adopt-a-young-parent \
     --member="serviceAccount:firebase-adminsdk-fbsvc@adopt-a-young-parent.iam.gserviceaccount.com" \
     --role="roles/firebase.admin"
   ```

### "Invalid Credentials" Error

**Problem:** GitHub Actions failing with authentication error

**Solution:**
1. Verify the GitHub secret was updated correctly
2. Check the secret value is the entire JSON file, not just the private key
3. Ensure there are no extra spaces or newlines
4. Try deleting and recreating the secret instead of updating

### "Secret Not Found" Error

**Problem:** Firebase deployment can't find the secret

**Solution:**
1. Verify secret exists:
   ```bash
   firebase apphosting:secrets:list --project adopt-a-young-parent
   ```

2. Check secret name matches apphosting.yaml:
   ```yaml
   - variable: FIREBASE_PRIVATE_KEY
     secret: firebase-admin-private-key  # Must match
   ```

3. Recreate the secret if needed

### Environment Variable Not Persisting

**Problem:** `$env:FIREBASE_SERVICE_ACCOUNT_PATH` is lost when opening new terminal

**Solution:**
1. Add to PowerShell profile (see Step 6)
2. Or set as Windows system environment variable:
   ```powershell
   [System.Environment]::SetEnvironmentVariable(
       'FIREBASE_SERVICE_ACCOUNT_PATH',
       'C:\firebase-credentials\firebase-service-account.json',
       [System.EnvironmentVariableTarget]::User
   )
   ```

---

## Post-Setup Checklist

- [ ] New service account key generated and saved securely
- [ ] Key details documented (key ID, date, purpose)
- [ ] GitHub Actions secret updated
- [ ] Firebase Secret Manager updated
- [ ] Old compromised key deleted from Firebase
- [ ] Environment variable configured
- [ ] PowerShell profile updated (if applicable)
- [ ] Local development tested
- [ ] GitHub Actions workflow tested
- [ ] Firebase deployment tested
- [ ] Key rotation scheduled (90 days)

---

## Next Steps

1. **Complete Git History Cleanup:**
   - See `SECURITY_REMEDIATION.md` for full instructions
   - Run `.\cleanup-git-history.ps1` to remove old key from Git

2. **Review Audit Logs:**
   - Check for any unauthorized access using the old key
   - See "Step 5" in `SECURITY_REMEDIATION.md`

3. **Set Rotation Reminder:**
   - Add calendar event for 90 days from now
   - Title: "Rotate Firebase Service Account Key"
   - Include this document link in the event

4. **Document Key ID:**
   - Save the new key ID in your password manager or secure notes
   - You'll need it for future rotations

---

## Key Information Template

Copy and save this information securely:

```
Service Account: firebase-adminsdk-fbsvc@adopt-a-young-parent.iam.gserviceaccount.com
Project ID: adopt-a-young-parent
Key ID: [paste from step 1]
Generated Date: [today's date]
Generated By: [your name]
Next Rotation: [90 days from now]
File Location: C:\firebase-credentials\firebase-service-account.json
Purpose: Replace compromised key after security incident
```

---

## Support Resources

- **Firebase Admin SDK Docs:** https://firebase.google.com/docs/admin/setup
- **GitHub Actions Secrets:** https://docs.github.com/en/actions/security-guides/encrypted-secrets
- **Firebase Secret Manager:** https://firebase.google.com/docs/hosting/manage-secrets
- **Security Incident Documentation:** See `SECURITY_REMEDIATION.md`
- **Credential Management Guide:** See `CREDENTIAL_MANAGEMENT.md`

---

**Last Updated:** October 17, 2025
**Version:** 1.0
**Estimated Time:** 15-20 minutes
